#include <Wire.h>
#include <LiquidCrystal.h>
#include <Encoder.h>  // For measuring distance

// --- LCD ---
LiquidCrystal lcd(8, 9, 4, 5, 6, 7);

// --- MOTOR PINS ---
const int ENA = A1, IN1 = 12, IN2 = 13;  // Left motor
const int ENB = 3,  IN3 = 2,  IN4 = 1;  // Right motor

// --- SENSORS ---
const int leftSensor = A2;
const int rightSensor = A3;

// --- SPEED SETTINGS ---
int leftSpeed = 180;
int rightSpeed = 235;

// --- LINE FOLLOWING THRESHOLD ---
int threshold = 400;

// --- ENCODER PINS ---
Encoder leftEnc(7, 6);   // Example pins for left encoder
Encoder rightEnc(5, 4);  // Example pins for right encoder

// --- DISTANCE VARIABLES ---
float wheelCircumference = 20.0; // cm (example: adjust to wheel diameter)
long prevLeftCounts = 0;
long prevRightCounts = 0;
float totalDistance = 0;
float stopDistance = 400; // stop for 3 sec at 400 cm

// --- STATE VARIABLES ---
bool pausedAt400cm = false;
bool finishedTrack = false;
unsigned long startTime;
unsigned long endTime;

void setup() {
  pinMode(ENA, OUTPUT); pinMode(IN1, OUTPUT); pinMode(IN2, OUTPUT);
  pinMode(ENB, OUTPUT); pinMode(IN3, OUTPUT); pinMode(IN4, OUTPUT);
  
  pinMode(leftSensor, INPUT);
  pinMode(rightSensor, INPUT);

  lcd.begin(16,2);
  lcd.print("Starting LineRun");

  startTime = millis();
}

void loop() {
  if (finishedTrack) return; // Stop all actions if track finished

  unsigned long currentTime = millis();

  // --- READ ENCODERS ---
  long leftCounts  = leftEnc.read();
  long rightCounts = rightEnc.read();
  long deltaLeft   = leftCounts - prevLeftCounts;
  long deltaRight  = rightCounts - prevRightCounts;
  prevLeftCounts   = leftCounts;
  prevRightCounts  = rightCounts;

  // Average distance traveled by both wheels
  float distanceTraveled = ((deltaLeft + deltaRight) / 2.0) * (wheelCircumference / 20.0); 
  totalDistance += distanceTraveled;

  // --- READ LINE SENSORS ---
  int L = analogRead(leftSensor);
  int R = analogRead(rightSensor);

  bool leftOnLine  = L > threshold;
  bool rightOnLine = R > threshold;

  // --- LINE FOLLOWING LOGIC ---
  if (leftOnLine && rightOnLine) {
    moveForward();
  }
  else if (leftOnLine && !rightOnLine) {
    turnRightStrong();
  }
  else if (!leftOnLine && rightOnLine) {
    turnLeftStrong();
  }
  else {
    searchLine();
  }

  // --- PAUSE FOR 3 SEC AT 400CM ---
  if (!pausedAt400cm && totalDistance >= stopDistance) {
    stopMotors();
    pausedAt400cm = true;
    lcd.clear();
    lcd.print("Pausing at 400cm");
    delay(3000);
  }

  // --- DETECT END OF TRACK (BLACK LINE) ---
  if (pausedAt400cm && leftOnLine && rightOnLine && totalDistance > stopDistance) {
    stopMotors();
    finishedTrack = true;
    endTime = millis();
    displayResults();
  }

  delay(50);
}

// ---------------------------
// MOTOR FUNCTIONS
// ---------------------------
void moveForward() {
  digitalWrite(IN1, HIGH); digitalWrite(IN2, LOW); analogWrite(ENA, leftSpeed);
  digitalWrite(IN3, HIGH); digitalWrite(IN4, LOW); analogWrite(ENB, rightSpeed);
}

void stopMotors() {
  digitalWrite(IN1, LOW); digitalWrite(IN2, LOW); analogWrite(ENA, 0);
  digitalWrite(IN3, LOW); digitalWrite(IN4, LOW); analogWrite(ENB, 0);
}

void turnLeftStrong() {
  digitalWrite(IN1, LOW);  digitalWrite(IN2, HIGH); analogWrite(ENA, leftSpeed);
  digitalWrite(IN3, HIGH); digitalWrite(IN4, LOW);  analogWrite(ENB, rightSpeed);
}

void turnRightStrong() {
  digitalWrite(IN1, HIGH); digitalWrite(IN2, LOW);  analogWrite(ENA, leftSpeed);
  digitalWrite(IN3, LOW);  digitalWrite(IN4, HIGH); analogWrite(ENB, rightSpeed);
}

void searchLine() {
  digitalWrite(IN1, LOW);  digitalWrite(IN2, HIGH); analogWrite(ENA, 80);
  digitalWrite(IN3, HIGH); digitalWrite(IN4, LOW);  analogWrite(ENB, 80);
}

// ---------------------------
// DISPLAY RESULTS ON LCD
// ---------------------------
void displayResults() {
  float timeSec = (endTime - startTime) / 1000.0;
  lcd.clear();
  lcd.print("Distance(cm):");
  lcd.setCursor(0,1);
  lcd.print(totalDistance, 1);
  delay(3000);

  lcd.clear();
  lcd.print("Time(s):");
  lcd.setCursor(0,1);
  lcd.print(timeSec, 2);
  delay(5000);
}
